'use strict';

exports.__esModule = true;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _AudioPlayer = require('../../containers/AudioPlayer');

var _AudioPlayer2 = _interopRequireDefault(_AudioPlayer);

var _Chip = require('@material-ui/core/Chip');

var _Chip2 = _interopRequireDefault(_Chip);

var _Icon = require('@material-ui/core/Icon');

var _Icon2 = _interopRequireDefault(_Icon);

var _IconButton = require('@material-ui/core/IconButton');

var _IconButton2 = _interopRequireDefault(_IconButton);

var _materialUiImage = require('material-ui-image');

var _materialUiImage2 = _interopRequireDefault(_materialUiImage);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactRedux = require('react-redux');

var _reactIntl = require('react-intl');

var _actions = require('../../store/simpleValues/actions');

var _firekitProvider = require('firekit-provider');

var _reactRouterDom = require('react-router-dom');

var _styles = require('@material-ui/core/styles');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var ChatMessage = function (_Component) {
  _inherits(ChatMessage, _Component);

  function ChatMessage() {
    _classCallCheck(this, ChatMessage);

    return _possibleConstructorReturn(this, _Component.apply(this, arguments));
  }

  ChatMessage.prototype.componentDidMount = function componentDidMount() {
    var _props = this.props,
        row = _props.row,
        auth = _props.auth,
        firebaseApp = _props.firebaseApp,
        path = _props.path;


    var values = row.val;

    if (auth.uid !== values.authorUid && !values.isRead) {
      firebaseApp.database().ref(path + '/' + row.key).update({
        isRead: true
      });
      firebaseApp.database().ref('user_chats/' + auth.uid + '/' + values.authorUid + '/unread').remove();
    }
  };

  ChatMessage.prototype.render = function render() {
    var _props2 = this.props,
        dataChanged = _props2.dataChanged,
        authorChanged = _props2.authorChanged,
        theme = _props2.theme,
        auth = _props2.auth,
        values = _props2.values,
        backgroundColor = _props2.backgroundColor,
        color = _props2.color,
        intl = _props2.intl,
        history = _props2.history,
        type = _props2.type;


    var bColor = theme.palette.type === 'light' ? theme.palette.grey[300] : theme.palette.grey[700];

    return _react2.default.createElement(
      'div',
      { style: { width: '100%' } },
      _react2.default.createElement(
        'div',
        null,
        dataChanged && _react2.default.createElement(
          'div',
          {
            style: {
              width: '100%',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              paddingTop: 10,
              paddingBottom: 10
            }
          },
          _react2.default.createElement(
            'div',
            null,
            _react2.default.createElement(_Chip2.default, {
              label: '' + (values.created ? intl.formatRelative(new Date(values.created), { units: 'day' }) : undefined),
              backgroundColor: bColor
            })
          )
        ),
        _react2.default.createElement(
          'div',
          {
            style: {
              display: 'flex',
              width: '100%',
              justifyContent: values.authorUid === auth.uid ? 'flex-end' : 'flex-start'
            }
          },
          _react2.default.createElement(
            'div',
            {
              style: _extends({}, theme.chip, {
                margin: 1,
                marginTop: authorChanged === true ? 8 : 1,
                boxShadow: theme.shadows[3],
                borderRadius: authorChanged === true ? values.authorUid === auth.uid ? '8px 0 8px 8px' : '0 8px 8px 8px' : '8px 8px 8px 8px',
                backgroundColor: backgroundColor,
                color: color,
                fontFamily: theme.typography.fontFamily
              })
            },
            _react2.default.createElement(
              'div',
              {
                style: {
                  display: 'flex',
                  margin: 5,
                  flexOrientation: 'row',
                  justifyContent: 'space-between',
                  width: 'fit-content'
                }
              },
              _react2.default.createElement(
                'div',
                {
                  style: {
                    maxWidth: 500,
                    width: 'fit-content',
                    fontSize: 16,
                    paddingLeft: 8,
                    margin: 'auto',
                    whiteSpace: 'pre-wrap',
                    overflowWrap: 'break-word',
                    fontFamily: theme.typography.fontFamily
                  }
                },
                values.authorUid !== auth.uid && _react2.default.createElement(
                  'div',
                  {
                    onClick: function onClick() {
                      history.push('/chats/edit/' + values.authorUid);
                    },
                    style: { color: theme.palette.secondary.main, fontSize: 12, marginLeft: 0, cursor: 'pointer' }
                  },
                  values.authorName
                ),
                type === 'location' && _react2.default.createElement(
                  'div',
                  { style: { padding: 7 } },
                  _react2.default.createElement(
                    'div',
                    { style: { textAlign: 'center', width: '100%', height: '100%' } },
                    _react2.default.createElement(
                      _IconButton2.default,
                      { target: '_blank', href: values.location },
                      _react2.default.createElement(
                        _Icon2.default,
                        { className: 'material-icons', color: theme.palette.secondary.main },
                        'map'
                      )
                    ),
                    intl.formatMessage({ id: 'my_location' })
                  )
                ),
                type === 'audio' && _react2.default.createElement(
                  'div',
                  { style: { padding: 7 } },
                  _react2.default.createElement(_AudioPlayer2.default, { src: values.audio, authorPhotoUrl: values.authorPhotoUrl })
                ),
                type === 'link' && _react2.default.createElement(
                  'a',
                  { target: '_blank', rel: 'noopener noreferrer', href: values.link },
                  values.link
                ),
                type === 'image' && values.image !== null && _react2.default.createElement(_materialUiImage2.default, {
                  style: { width: 'auto', height: 280, paddingTop: 0 },
                  imageStyle: { maxWidth: '100%', padding: 0, position: 'relative', borderRadius: 5 },
                  onLoad: this.scrollToBottom,
                  src: values.image,
                  color: backgroundColor
                }),
                type === 'text' && values.message
              ),
              _react2.default.createElement(
                'div',
                {
                  style: {
                    fontSize: 9,
                    color: values.authorUid !== auth.uid ? theme.palette.text.secondary : theme.palette.text.secondary,
                    marginLeft: 8,
                    alignSelf: 'flex-end'
                  }
                },
                '' + (values.created ? intl.formatTime(new Date(values.created)) : undefined),
                values.isSend && _react2.default.createElement(
                  _Icon2.default,
                  {
                    style: {
                      fontSize: 11,
                      padding: 0,
                      paddingLeft: 2,
                      bottom: -2,
                      color: values.isRead ? theme.palette.secondary.main : theme.palette.text.primary
                    }
                  },
                  values.isReceived ? 'done_all' : 'done'
                )
              )
            )
          )
        )
      )
    );
  };

  return ChatMessage;
}(_react.Component);

ChatMessage.propTypes = process.env.NODE_ENV !== "production" ? {
  intl: _reactIntl.intlShape.isRequired,
  theme: _propTypes2.default.object.isRequired
} : {};

var mapStateToProps = function mapStateToProps(state) {
  var auth = state.auth;


  return {
    auth: auth
  };
};

exports.default = (0, _reactRedux.connect)(mapStateToProps, { setSimpleValue: _actions.setSimpleValue })((0, _reactIntl.injectIntl)((0, _styles.withTheme)()((0, _reactRouterDom.withRouter)((0, _firekitProvider.withFirebase)(ChatMessage)))));
module.exports = exports['default'];